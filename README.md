### Vulnerability case study presentations 
### Hancheng Lei(251099234), Siyang Li(251129414) 
# CVE-2020-1938: Ghostcat-Apache Tomcat AJP File Read/Inclusion Vulnerability 

## Background

### When it was discovered？
On February 20, China National Vulnerability Database (CNVD) published a security advisory for CNVD-2020-10487, a severe vulnerability in Apache Tomcat’s Apache JServ Protocol (or AJP). AJP is a binary protocol designed to handle requests sent to a web server destined for an application server in order to improve performance. 

The vulnerability (CVE-2020-1938), dubbed Ghostcat, was discovered by researchers at Chaitin Tech and reported to the Apache Software Foundation on January 3, 2020 [1].

### What is Apache Tomcat?
Apache Tomcat (called "Tomcat" for short) is an open-source implementation of the Java Servlet, JavaServer Pages, Java Expression Language and WebSocket technologies.Tomcat provides a "pure Java" HTTP web server environment in which Java code can run.

Tomcat is developed and maintained by an open community of developers under the auspices of the Apache Software Foundation, released under the Apache License 2.0 license [2].

### What is AJP Protocol?
The AJP is a binary protocol used by the Apache Tomcat webserver to communicate with the servlet container that sits behind the webserver using TCP connections. It is mainly used in a cluster or reverse proxy scenario where web servers communicate with application servers or servlet containers.

### What is CVE-2020-1938?
CVE-2020-1938 is a file read/inclusion vulnerability in the AJP connector in Apache Tomcat. This is enabled by default with a default configuration port of 8009. A remote, unauthenticated attacker could exploit this vulnerability to read web application files from a vulnerable server. In instances where the vulnerable server allows file uploads, an attacker could upload malicious JavaServer Pages (JSP) code within a variety of file types and trigger this vulnerability to gain remote code execution (RCE) [1].

## Description
### Official Description[3]
>When using the Apache JServ Protocol (AJP), care must be taken when trusting incoming connections to Apache Tomcat. Tomcat treats AJP connections as having higher trust than, for example, a similar HTTP connection. If such connections are available to an attacker, they can be exploited in ways that may be surprising. In Apache Tomcat 9.0.0.M1 to 9.0.0.30, 8.5.0 to 8.5.50 and 7.0.0 to 7.0.99, Tomcat shipped with an AJP Connector enabled by default that listened on all configured IP addresses. It was expected (and recommended in the security guide) that this Connector would be disabled if not required. This vulnerability report identified a mechanism that allowed: - returning arbitrary files from anywhere in the web application - processing any file in the web application as a JSP Further, if the web application allowed file upload and stored those files within the web application (or
the attacker was able to control the content of the web application by some other means) then this, along with the ability to process a file as a JSP, made remote code execution possible. It is important to note that mitigation is only required if an AJP port is accessible to untrusted users. Users wishing to take a defence-in-depth approach and block the vector that permits returning arbitrary files and execution as JSP may upgrade to Apache Tomcat 9.0.31, 8.5.51 or 7.0.100 or later. A number of changes were made to the default AJP Connector configuration in 9.0.31 to harden the default configuration. It is likely that users upgrading to 9.0.31, 8.5.51 or 7.0.100 or later will need to make small changes to their configurations.

### Explain in simple words
+ Basic conditions:  
  Apache Tomcat versions 6.x, 7.x, 8.x, and 9.x allows remote code execution when the AJP connector, which is enabled by default and listens on all addresses on port 8009, is treated with more trust than a connection such as HTTP. In this circumstances, an attacker can be allowed to exploit it to perform actions that are not intended for an untrusted user.
+ Ghostcat allows an attacker to retrieve arbitrary files from anywhere in the web application, including the `WEB-INF` and `META-INF` directories and any other location that can be reached via `ServletContext.getResourceAsStream()`. It also allows the attacker to process any file in the web application as JSP[4].
+  If an application running on an affected version of Tomcat contains a file upload vulnerability, an attacker can exploit it in combination with Ghostcat to achieve remote code execution. 
  
## Impact
According to a post in the Apache Software Foundation Blog from 2010, Apache Tomcat has been downloaded over 10 million times. Apache Tomcat is used by a variety of software applications, often bundled as an embedded web server. The potential impact of this vulnerability is wide, if the vulnerability is not fixed, these users and their data will be at risk.

### Affected Versions and Fixed Version [1]
Apache Version|Affected Release Versions|Fixed Version
---|:--:|---:
Apache Tomcat 9|9.0.30 and below|9.0.31
Apache Tomcat 8|8.5.50 and below|8.5.51
Apache Tomcat 7|7.0.99 and below|7.0.100

## Vulnerability Analysis and Exploits

### Vulnerability principle:

When tomcat processes a request, it will try to get the value from Request Attribute of javax.servlet.include.servlet_path. The Default Servlet takes it as the file path of the static resource file to be requested and JspServlet takes it as the file path of the JSP file to be requested. Because this attribute is controllable, we can read any file in the webapp directory through the Request Attribute.

The vulnerability exists when the conditions of RCE are met:

Web applications need to allow files to be uploaded and stored in web applications. Otherwise, attackers will have to control the content of web applications in some way. This situation, together with the ability to process files as JSPS (through vulnerabilities), will make rce possible.

steps:
1. Through ghostcat vulnerability, an attacker can read any file in the webapp directory deployed under Tomcat by using the AJP connection which is usually found on port 8009.

2. At the same time, if this application has upload function in the website service, the attacker can also upload a malicious file containing JSP code to the server (upload file can be any type, image, plain text file, etc.), and then use ghostcat to include the file, so as to achieve the harm of code execution.

### Exploits Demo
Tools: Kali-linux 64 bit Virtual Machine, Tomcat-8.5.32, JRE8 environment. 

1. Search the image of tomcat-8.5.32 by Docker[5].
   
   command: `docker search tomcat-8.5.32`
   
   the command of docker installation: `apt install docker.io`

![search image](https://github.com/Siyang9065/img/blob/main/search%20image.png?raw=true "search image")

2. Pull image of tomcat and load it to local virtual machine.
   
   command: `docker search duonghuuphuc/tomcat-8.5.32` 

![pull image](https://github.com/Siyang9065/img/blob/main/pull%20image.png?raw=true "pull image")

3. Run ports 8080 and 8009 after create the container of this image.
   
   command: `docker run -d -p 8080:8080 -p 8009:8009 --name ghostcat duonghuuphuc/tomcat-8.5.32`
  
   -d: Run container in background and return container ID.
   
   -p: the internal port of the container is bound to the specified host port.
   
   --name: specify the name of container.

![run ports](https://github.com/Siyang9065/img/blob/main/run%20tomcat.png?raw=true "run ports 8080 and 8009 ")

4. Use the tool Nmap[6] to scan whether the ports 8080 and 8009 of the local IP address are open.
   
   command: `nmap <IP address>`

![check ports](https://github.com/Siyang9065/img/blob/main/check%20ports.png?raw=true "check ports")

5. Check if the Tomcat environment is working properly in web browser.

![run tomcat](https://github.com/Siyang9065/img/blob/main/tomcat-8.5.32.png?raw=true "run tomcat")

6. Run python vulnerability script in the host port 8009 to read files which are in the webapp directory.
   
   command: `python CVE-2020-1938.py <IP address> -p 8009 -f WEB-INF/web.xml`
   
   -p: specify the port
   
   -f: specify the location of the file to be read 

![exploit script](https://github.com/Siyang9065/img/blob/main/exploit%20script.png?raw=true "exploit script")

![read web file](https://github.com/Siyang9065/img/blob/main/read%20files.png?raw=true "run web file")

![read index file](https://github.com/Siyang9065/img/blob/main/read%20index%20file.png?raw=true "run index file")

## Workaround
The best way is updating your Apache Tomcat version to the latest one, for example, 9.0.31.

If an upgrade is not possible, the requiredSecret attribute can be configured to set AJP protocol authentication credentials like so:

`<Connector port="8009" protocol="AJP/1.3" redirectPort="8443" address="YOUR_TOMCAT_IP_ADDRESS" secret="YOUR_TOMCAT_AJP_SECRET"/>`

## References
[1]https://www.tenable.com/blog/cve-2020-1938-ghostcat-apache-tomcat-ajp-file-readinclusion-vulnerability-cnvd-2020-10487

[2]https://en.wikipedia.org/wiki/Apache_Tomcat

[3]https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-1938\

[4]https://www.synopsys.com/blogs/software-security/ghostcat-vulnerability-cve-2020-1938/

[5]https://www.docker.com/

[6]https://nmap.org/
